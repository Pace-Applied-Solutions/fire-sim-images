name: Deploy Static Web App

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (dev or prod)'
        required: false
        type: choice
        options:
          - dev
          - prod
        default: 'dev'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-swa:
    name: Build & Deploy to Azure Static Web Apps
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      # -- 1. Install at workspace root --
      - name: Install dependencies
        run: npm ci

      # -- 2. Build everything from workspace root --
      - name: Build shared package
        run: npm run build --workspace=packages/shared

      - name: Build web app
        run: npm run build --workspace=apps/web
        env:
          VITE_MAPBOX_TOKEN: ${{ secrets.VITE_MAPBOX_TOKEN }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

      - name: Build API
        run: npm run build --workspace=apps/api

      # -- 3. Assemble standalone API directory --
      #    npm workspace symlinks break when zipped, so we assemble a
      #    self-contained API folder with real file copies only.
      - name: Prepare API deployment package
        run: |
          mkdir -p .deploy/api

          # Runtime config
          cp apps/api/host.json .deploy/api/

          # Compiled API code
          cp -R apps/api/dist .deploy/api/dist

          # package.json without @fire-sim/shared (we place it manually)
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('apps/api/package.json', 'utf8'));
            delete pkg.dependencies['@fire-sim/shared'];
            delete pkg.devDependencies;
            delete pkg.scripts;
            fs.writeFileSync('.deploy/api/package.json', JSON.stringify(pkg, null, 2));
          "

          # Install only external production deps (no workspace refs)
          cd .deploy/api
          npm install --omit=dev

          # Manually place built @fire-sim/shared into node_modules (real copy, no symlinks)
          mkdir -p node_modules/@fire-sim/shared
          cp -R ../../packages/shared/dist   node_modules/@fire-sim/shared/dist
          cp    ../../packages/shared/package.json node_modules/@fire-sim/shared/package.json

      # -- 4. Verify API package resolves correctly --
      - name: Verify API module resolution
        run: |
          cd .deploy/api
          node -e "const p = require.resolve('@fire-sim/shared'); console.log('Shared resolved to:', p); if (!p.includes('.deploy')) { process.exit(1); }"

      # -- 5. Deploy pre-built artifacts --
      #    skip_app_build + skip_api_build: SWA uploads our pre-built output as-is.
      #    apiRuntime in staticwebapp.config.json (copied to dist/ by Vite) tells
      #    the SWA platform which Node.js version to use for the managed functions.
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web
          output_location: dist
          api_location: .deploy/api
          skip_app_build: true
          skip_api_build: true
          production_branch: main

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Static Web App Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
