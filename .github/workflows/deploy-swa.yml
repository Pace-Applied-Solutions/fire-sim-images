name: Deploy Static Web App

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-swa.yml'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  SWA_URL: https://gentle-mushroom-01c18080f.4.azurestaticapps.net

jobs:
  deploy-swa:
    name: Build & Deploy Front-end
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=packages/shared

      - name: Build web app
        run: npm run build --workspace=apps/web
        env:
          VITE_MAPBOX_TOKEN: ${{ secrets.VITE_MAPBOX_TOKEN }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_COMMIT_SHA: ${{ github.sha }}

      # Front-end only â€” no api_location.
      # The API is a standalone Azure Functions app linked via SWA "Bring Your Own Functions".
      # SWA automatically proxies /api/* to the linked backend.
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web/dist
          output_location: ''
          skip_app_build: true
          production_branch: main

      # Verify the deployed page contains the expected commit SHA
      - name: Verify deployment
        id: verify
        run: |
          EXPECTED="${{ github.sha }}"
          SHORT_SHA="${EXPECTED:0:7}"
          URL="${{ env.SWA_URL }}"
          MAX_ATTEMPTS=18       # 18 Ã— 10s = 3 minutes
          ATTEMPT=0

          echo "Waiting for $URL to contain commit $SHORT_SHA ..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10

            # Fetch the page and look for the commit SHA in meta tag or page content
            PAGE=$(curl -s -m 10 "$URL" 2>/dev/null || echo '')

            if echo "$PAGE" | grep -q "$EXPECTED"; then
              echo "âœ… Deployment verified â€” commit $SHORT_SHA found in page"
              echo "deploy_verified=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS â€” commit not found yet"
          done

          echo "âŒ Deployment verification failed after $MAX_ATTEMPTS attempts"
          echo "Expected commit SHA: $EXPECTED"
          echo "deploy_verified=false" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const swaUrl = '${{ env.SWA_URL }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ SWA deployment failed (${sha})`,
              labels: ['infrastructure', 'bug'],
              assignees: ['copilot'],
              body: [
                `## Static Web App Deployment Failure`,
                ``,
                `**Commit:** \`${context.sha}\``,
                `**Branch:** \`${context.ref}\``,
                `**Workflow run:** ${runUrl}`,
                `**Timestamp:** ${new Date().toISOString()}`,
                ``,
                `### What happened`,
                `The front-end deployment to Azure Static Web Apps either failed or the deployed page does not contain the expected commit SHA within the timeout window (3 minutes).`,
                ``,
                `### Investigation steps`,
                `1. Check the [workflow run logs](${runUrl}) for build or deployment errors`,
                `2. Visit the site and inspect the \`<meta name="app-version">\` tag: ${swaUrl}`,
                `3. Check the built \`index.html\` references correct JS/CSS assets (not \`/src/main.tsx\`)`,
                `4. Verify \`staticwebapp.config.json\` is in the \`dist/\` output:`,
                `   - \`navigationFallback.exclude\` must include \`/assets/*\` to prevent JS files being rewritten to \`index.html\``,
                `   - \`mimeTypes\` must map \`.js\` to \`text/javascript\``,
                `5. Check the SWA deployment token is still valid:`,
                `   \`\`\`bash`,
                `   az staticwebapp secrets list --name firesim-dev-web --resource-group firesim-rg-dev`,
                `   \`\`\``,
                `6. Try a manual redeploy via workflow_dispatch`,
                ``,
                `### Expected`,
                `- **Commit SHA in page:** \`${context.sha}\``,
                `- **Site URL:** ${swaUrl}`,
              ].join('\n'),
            });
