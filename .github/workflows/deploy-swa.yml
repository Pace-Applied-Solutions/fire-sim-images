name: Deploy Static Web App

on:
  push:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-swa.yml'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  SWA_URL: https://gentle-mushroom-01c18080f.4.azurestaticapps.net

jobs:
  deploy-swa:
    name: Build & Deploy Front-end
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Begin summary
        run: |
          echo "## ðŸš€ Deploy Static Web App" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkout repository | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Node.js | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Install dependencies
        id: install
        run: |
          npm ci
          echo "| Install dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record install failure
        if: failure() && steps.install.outcome == 'failure'
        run: echo "| Install dependencies | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Build shared package
        id: build_shared
        run: |
          npm run build --workspace=packages/shared
          echo "| Build shared package | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record build shared failure
        if: failure() && steps.build_shared.outcome == 'failure'
        run: echo "| Build shared package | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Build web app
        id: build_web
        run: |
          npm run build --workspace=apps/web
          echo "| Build web app | âœ… |" >> $GITHUB_STEP_SUMMARY
        env:
          VITE_MAPBOX_TOKEN: ${{ secrets.VITE_MAPBOX_TOKEN }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_COMMIT_SHA: ${{ github.sha }}

      - name: Record build web failure
        if: failure() && steps.build_web.outcome == 'failure'
        run: echo "| Build web app | âŒ |" >> $GITHUB_STEP_SUMMARY

      # Front-end only â€” no api_location.
      # The API is a standalone Azure Functions app linked via SWA "Bring Your Own Functions".
      # SWA automatically proxies /api/* to the linked backend.
      - name: Deploy to Azure Static Web Apps
        id: deploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location: apps/web/dist
          output_location: ''
          skip_app_build: true
          production_branch: main

      - name: Record deploy status
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "| Deploy to Azure Static Web Apps | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.deploy.outcome }}" = "failure" ]; then
            echo "| Deploy to Azure Static Web Apps | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

      # Verify the deployed page contains the expected commit SHA in a build-time meta tag
      - name: Verify deployment
        id: verify
        run: |
          EXPECTED="${{ github.sha }}"
          SHORT_SHA="${EXPECTED:0:7}"
          URL="${{ env.SWA_URL }}"
          MAX_ATTEMPTS=18       # 18 Ã— 10s = 3 minutes
          ATTEMPT=0

          echo "Waiting for $URL to contain commit $SHORT_SHA in <meta name=app-version> ..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            sleep 10

            PAGE=$(curl -s -m 10 "$URL" 2>/dev/null || echo '')

            # Check the build-time meta tag injected by Vite transformIndexHtml
            if echo "$PAGE" | grep -q "app-version.*$EXPECTED"; then
              echo "âœ… Deployment verified â€” commit $SHORT_SHA found in <meta name=app-version>"
              echo "deploy_verified=true" >> "$GITHUB_OUTPUT"
              echo "| Verify deployment (commit SHA) | âœ… |" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            # Also verify we're not serving the source index.html
            if echo "$PAGE" | grep -q '/src/main.tsx'; then
              echo "âš ï¸  Still serving source index.html â€” deployment may not have propagated yet"
            fi

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS â€” commit not found yet"
          done

          echo "âŒ Deployment verification failed after $MAX_ATTEMPTS attempts"
          echo "Expected commit SHA: $EXPECTED"
          echo "deploy_verified=false" >> "$GITHUB_OUTPUT"
          echo "| Verify deployment (commit SHA) | âŒ |" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Final summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify.outcome }}" = "success" ]; then
            echo "> âœ… **Front-end deployed and verified** â€” commit \`${{ github.sha }}\` is live at ${{ env.SWA_URL }}" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "> âš ï¸ **Front-end deployed but verification failed** â€” the app may still be propagating" >> $GITHUB_STEP_SUMMARY
          else
            echo "> âŒ **Front-end deployment failed** â€” see table above for details" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const swaUrl = '${{ env.SWA_URL }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ SWA deployment failed (${sha})`,
              labels: ['infrastructure', 'bug'],
              body: [
                `## Static Web App Deployment Failure`,
                ``,
                `**Commit:** \`${context.sha}\``,
                `**Branch:** \`${context.ref}\``,
                `**Workflow run:** ${runUrl}`,
                `**Timestamp:** ${new Date().toISOString()}`,
                ``,
                `### What happened`,
                `The front-end deployment to Azure Static Web Apps either failed or the deployed page does not contain the expected commit SHA within the timeout window (3 minutes).`,
                ``,
                `### Quick Fix`,
                `**Most common cause:** Stale deployment token after infrastructure redeployment.`,
                ``,
                `**Solution:** Update the \`AZURE_STATIC_WEB_APPS_API_TOKEN\` GitHub secret with the current token from Azure:`,
                `\`\`\`bash`,
                `az staticwebapp secrets list --name firesim-dev-web --resource-group firesim-rg-dev --query "properties.apiKey" -o tsv`,
                `\`\`\``,
                `Then update the secret at: https://github.com/${context.repo.owner}/${context.repo.repo}/settings/secrets/actions`,
                ``,
                `### Detailed Troubleshooting`,
                `See the [SWA Deployment Troubleshooting Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/TROUBLESHOOTING_SWA_DEPLOYMENT.md) for:`,
                `- Step-by-step resolution instructions`,
                `- Alternative fixes if updating the token doesn't work`,
                `- Prevention strategies`,
                ``,
                `### Investigation steps`,
                `1. Check the [workflow run logs](${runUrl}) for build or deployment errors`,
                `2. Visit the site and inspect the \`<meta name="app-version">\` tag: ${swaUrl}`,
                `3. Check the built \`index.html\` references correct JS/CSS assets (not \`/src/main.tsx\`)`,
                `4. Verify \`staticwebapp.config.json\` is in the \`dist/\` output:`,
                `   - \`navigationFallback.exclude\` must include \`/assets/*\` to prevent JS files being rewritten to \`index.html\``,
                `   - \`mimeTypes\` must map \`.js\` to \`text/javascript\``,
                `5. If the quick fix doesn't work, try a manual infrastructure redeploy`,
                ``,
                `### Expected`,
                `- **Commit SHA in page:** \`${context.sha}\``,
                `- **Site URL:** ${swaUrl}`,
              ].join('\n'),
            });
