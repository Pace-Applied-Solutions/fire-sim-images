name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/shared/**'
      - '.github/workflows/deploy-api.yml'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  AZURE_FUNCTIONAPP_NAME: firesim-dev-api
  NODE_VERSION: '22.x'

jobs:
  deploy-api:
    name: Build & Deploy API
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Begin summary
        run: |
          echo "## ðŸš€ Deploy API â€” \`${{ env.AZURE_FUNCTIONAPP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkout repository | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Node.js ${{ env.NODE_VERSION }} | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Install dependencies
        id: install
        run: |
          npm ci
          echo "| Install dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record install failure
        if: failure() && steps.install.outcome == 'failure'
        run: echo "| Install dependencies | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Build shared package
        id: build_shared
        run: |
          npm run build --workspace=packages/shared
          echo "| Build shared package | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record build shared failure
        if: failure() && steps.build_shared.outcome == 'failure'
        run: echo "| Build shared package | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Build API
        id: build_api
        run: |
          npm run build --workspace=apps/api
          echo "| Build API | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record build API failure
        if: failure() && steps.build_api.outcome == 'failure'
        run: echo "| Build API | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Assemble deployment package
        id: assemble
        run: |
          set -e
          mkdir -p .deploy/api

          cp apps/api/host.json .deploy/api/
          cp -R apps/api/dist .deploy/api/dist

          node -e "
            const pkg = JSON.parse(require('fs').readFileSync('apps/api/package.json', 'utf8'));
            delete pkg.dependencies['@fire-sim/shared'];
            delete pkg.devDependencies;
            delete pkg.scripts;
            require('fs').writeFileSync('.deploy/api/package.json', JSON.stringify(pkg, null, 2));
          "

          cd .deploy/api
          npm install --omit=dev

          mkdir -p node_modules/@fire-sim/shared
          cp -R ../../packages/shared/dist   node_modules/@fire-sim/shared/dist
          cp    ../../packages/shared/package.json node_modules/@fire-sim/shared/package.json
          
          # Install shared package dependencies
          cd node_modules/@fire-sim/shared
          npm install --omit=dev
          cd ../..
          
          echo "| Assemble deployment package | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record assemble failure
        if: failure() && steps.assemble.outcome == 'failure'
        run: echo "| Assemble deployment package | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Verify module resolution
        run: |
          cd .deploy/api
          node -e "
            const shared = require.resolve('@fire-sim/shared');
            console.log('âœ“ @fire-sim/shared â†’', shared);
            const funcs = require.resolve('@azure/functions');
            console.log('âœ“ @azure/functions â†’', funcs);
          "
          echo "| Verify module resolution | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        id: deploy
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: .deploy/api

      - name: Record deploy status
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" = "success" ]; then
            echo "| Azure Login | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Deploy to Azure Functions | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.deploy.outcome }}" = "failure" ]; then
            echo "| Azure Login | âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Deploy to Azure Functions | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

      # Stamp the commit SHA as an app setting so /api/health reports it
      - name: Set DEPLOY_COMMIT_SHA app setting
        id: commit_sha
        run: |
          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group firesim-rg-dev \
            --settings "DEPLOY_COMMIT_SHA=${{ github.sha }}" \
            -o none
          echo "| Set DEPLOY_COMMIT_SHA | âœ… |" >> $GITHUB_STEP_SUMMARY

      # Wait for the app to restart and verify the new version is live
      - name: Verify deployment (attempt 1)
        id: verify
        continue-on-error: true
        run: |
          EXPECTED="${{ github.sha }}"
          URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          MAX_ATTEMPTS=24       # 60s initial wait + 24 Ã— 10s = 5 minutes
          ATTEMPT=0

          echo "Waiting 60s for app to restart after deployment..."
          sleep 60
          echo "Starting health checks â€” expecting commitSha=$EXPECTED at $URL"
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s -m 10 "$URL" 2>/dev/null || echo '{}')
            LIVE_SHA=$(echo "$RESPONSE" | jq -r '.commitSha // empty' 2>/dev/null || echo '')
            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty' 2>/dev/null || echo '')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS â€” commitSha=$LIVE_SHA status=$STATUS"

            if [ "$LIVE_SHA" = "$EXPECTED" ]; then
              echo "âœ… Deployment verified â€” correct commit is live"
              echo "deploy_verified=true" >> "$GITHUB_OUTPUT"
              echo "| Verify deployment (health check) | âœ… |" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            sleep 10
          done

          echo "âš ï¸ Deployment verification failed after $MAX_ATTEMPTS attempts (5 minutes)"
          echo "Expected: $EXPECTED"
          echo "Got:      $LIVE_SHA"
          echo "deploy_verified=false" >> "$GITHUB_OUTPUT"
          echo "| Verify deployment attempt 1 (health check) | âŒ |" >> $GITHUB_STEP_SUMMARY
          exit 1

      # Retry deployment if first verification failed
      - name: Retry deployment
        id: retry_deploy
        if: steps.verify.outcome == 'failure'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: .deploy/api

      - name: Record retry deploy status
        if: steps.verify.outcome == 'failure'
        run: |
          if [ "${{ steps.retry_deploy.outcome }}" = "success" ]; then
            echo "| Retry deployment to Azure Functions | âœ… |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.retry_deploy.outcome }}" = "failure" ]; then
            echo "| Retry deployment to Azure Functions | âŒ |" >> $GITHUB_STEP_SUMMARY
          fi

      # Re-set the commit SHA app setting after retry
      - name: Set DEPLOY_COMMIT_SHA app setting (retry)
        id: commit_sha_retry
        if: steps.verify.outcome == 'failure' && steps.retry_deploy.outcome == 'success'
        run: |
          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group firesim-rg-dev \
            --settings "DEPLOY_COMMIT_SHA=${{ github.sha }}" \
            -o none
          echo "| Set DEPLOY_COMMIT_SHA (retry) | âœ… |" >> $GITHUB_STEP_SUMMARY

      # Verify deployment after retry
      - name: Verify deployment (attempt 2)
        id: verify_retry
        if: steps.verify.outcome == 'failure' && steps.retry_deploy.outcome == 'success'
        run: |
          EXPECTED="${{ github.sha }}"
          URL="https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          MAX_ATTEMPTS=24       # 60s initial wait + 24 Ã— 10s = 5 minutes
          ATTEMPT=0

          echo "Waiting 60s for app to restart after retry deployment..."
          sleep 60
          echo "Starting health checks (retry) â€” expecting commitSha=$EXPECTED at $URL"
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))

            RESPONSE=$(curl -s -m 10 "$URL" 2>/dev/null || echo '{}')
            LIVE_SHA=$(echo "$RESPONSE" | jq -r '.commitSha // empty' 2>/dev/null || echo '')
            STATUS=$(echo "$RESPONSE" | jq -r '.status // empty' 2>/dev/null || echo '')

            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS â€” commitSha=$LIVE_SHA status=$STATUS"

            if [ "$LIVE_SHA" = "$EXPECTED" ]; then
              echo "âœ… Deployment verified on retry â€” correct commit is live"
              echo "deploy_verified=true" >> "$GITHUB_OUTPUT"
              echo "| Verify deployment attempt 2 (health check) | âœ… |" >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            sleep 10
          done

          echo "âŒ Deployment verification failed after retry ($MAX_ATTEMPTS attempts, 5 minutes)"
          echo "Expected: $EXPECTED"
          echo "Got:      $LIVE_SHA"
          echo "deploy_verified=false" >> "$GITHUB_OUTPUT"
          echo "| Verify deployment attempt 2 (health check) | âŒ |" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Final summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          # Check if verification succeeded on first or second attempt
          if [ "${{ steps.verify.outcome }}" = "success" ]; then
            echo "> âœ… **API deployed and verified** â€” commit \`${{ github.sha }}\` is live" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.verify_retry.outcome }}" = "success" ]; then
            echo "> âœ… **API deployed and verified on retry** â€” commit \`${{ github.sha }}\` is live" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.deploy.outcome }}" = "success" ] || [ "${{ steps.retry_deploy.outcome }}" = "success" ]; then
            echo "> âš ï¸ **API deployed but verification failed** â€” the app may still be starting or experiencing issues" >> $GITHUB_STEP_SUMMARY
          else
            echo "> âŒ **API deployment failed** â€” see table above for details" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const sha = context.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const apiUrl = `https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health`;
            const retryAttempted = '${{ steps.retry_deploy.outcome }}' !== '';
            const retrySucceeded = '${{ steps.retry_deploy.outcome }}' === 'success';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ API deployment failed (${sha})`,
              labels: ['infrastructure', 'bug'],
              body: [
                `## API Deployment Failure`,
                ``,
                `**Commit:** \`${context.sha}\``,
                `**Branch:** \`${context.ref}\``,
                `**Workflow run:** ${runUrl}`,
                `**Timestamp:** ${new Date().toISOString()}`,
                ``,
                `### What happened`,
                retryAttempted 
                  ? `The API deployment to \`${{ env.AZURE_FUNCTIONAPP_NAME }}\` failed verification even after an automatic retry. The deployment ${retrySucceeded ? 'succeeded' : 'failed'} on retry, but the health endpoint did not return the expected commit SHA within the timeout window (5 minutes per attempt).`
                  : `The API deployment to \`${{ env.AZURE_FUNCTIONAPP_NAME }}\` either failed to deploy or did not come up with the expected commit SHA within the timeout window (5 minutes).`,
                ``,
                retryAttempted 
                  ? `**Retry attempted:** Yes (deploy ${retrySucceeded ? 'succeeded' : 'failed'})`
                  : '',
                ``,
                `### Investigation steps`,
                `1. Check the [workflow run logs](${runUrl}) for build or deployment errors`,
                `2. Check the Functions app health endpoint: \`curl ${apiUrl}\``,
                `3. Check Azure Functions runtime logs:`,
                `   \`\`\`bash`,
                `   az webapp log tail --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group firesim-rg-dev`,
                `   \`\`\``,
                `4. Verify the app setting was written:`,
                `   \`\`\`bash`,
                `   az functionapp config appsettings list --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group firesim-rg-dev --query "[?name=='DEPLOY_COMMIT_SHA'].value" -o tsv`,
                `   \`\`\``,
                `5. Check if the app is in a crash loop:`,
                `   \`\`\`bash`,
                `   az functionapp show --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group firesim-rg-dev --query state -o tsv`,
                `   \`\`\``,
                `6. Check deployment history:`,
                `   \`\`\`bash`,
                `   az functionapp log deployment list --name ${{ env.AZURE_FUNCTIONAPP_NAME }} --resource-group firesim-rg-dev -o table`,
                `   \`\`\``,
                ``,
                `### Expected vs Actual`,
                `- **Expected commitSha:** \`${context.sha}\``,
                `- **Health endpoint:** ${apiUrl}`,
                `- **Timeout window:** 5 minutes (24 attempts at 10-second intervals after 60s warmup)`,
              ].join('\n'),
            });
