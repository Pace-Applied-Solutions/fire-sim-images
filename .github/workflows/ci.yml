name: CI

on:
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Begin summary
        run: |
          echo "## ðŸ” CI â€” Continuous Integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkout code | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Node.js | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Install dependencies
        id: install
        run: |
          npm ci
          echo "| Install dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record install failure
        if: failure() && steps.install.outcome == 'failure'
        run: echo "| Install dependencies | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Build shared package
        id: build_shared
        run: |
          npm run build --workspace=packages/shared
          echo "| Build shared package | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record build shared failure
        if: failure() && steps.build_shared.outcome == 'failure'
        run: echo "| Build shared package | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Lint code
        id: lint
        run: |
          npm run lint
          echo "| Lint code | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record lint failure
        if: failure() && steps.lint.outcome == 'failure'
        run: echo "| Lint code | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Type check
        id: typecheck
        run: |
          npm run typecheck
          echo "| Type check | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record typecheck failure
        if: failure() && steps.typecheck.outcome == 'failure'
        run: echo "| Type check | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Run unit tests
        id: tests
        run: |
          npm run test:unit
          echo "| Unit tests | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Record tests failure
        if: failure() && steps.tests.outcome == 'failure'
        run: echo "| Unit tests | âŒ |" >> $GITHUB_STEP_SUMMARY

      - name: Generate coverage report
        id: coverage
        run: |
          npm run test:coverage
          echo "| Coverage report | âœ… |" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        continue-on-error: true
        with:
          files: |
            packages/shared/coverage/coverage-final.json
            apps/api/coverage/coverage-final.json
            apps/web/coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: CI Summary
        if: always()
        run: |
          echo "| Upload coverage | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.tests.outcome }}" = "success" ] && [ "${{ steps.lint.outcome }}" = "success" ] && [ "${{ steps.typecheck.outcome }}" = "success" ]; then
            echo "> âœ… **All CI checks passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "> âŒ **CI checks failed** â€” see table above for details" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Coverage thresholds are non-blocking during MVP development_" >> $GITHUB_STEP_SUMMARY

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: ci

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Begin summary
        run: |
          echo "## ðŸ§ª Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Checkout code | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Node.js | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Install dependencies
        run: |
          npm ci
          echo "| Install dependencies | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Build shared package
        run: |
          npm run build --workspace=packages/shared
          echo "| Build shared package | âœ… |" >> $GITHUB_STEP_SUMMARY

      - name: Run integration tests
        id: integration
        run: |
          npm run test:integration
          echo "| Integration tests | âœ… |" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Integration test summary
        if: always()
        run: |
          if [ "${{ steps.integration.outcome }}" != "success" ]; then
            echo "| Integration tests | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Integration tests require Azure resources and are run manually via workflow\_dispatch_" >> $GITHUB_STEP_SUMMARY
